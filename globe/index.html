<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      width: 100%;
      background-color:#000;
    }

    path {
    stroke:#676767; 
    stroke-width: 0.5px;
    fill: #0c0c0c;
  }

  @-webkit-keyframes pulse 
    {       
      0% {-webkit-transform: scale(1.0); opacity: 1;}
      100% {-webkit-transform: scale(2); opacity: 0;}
    }
    
    .pulse
    {
      /* Giving Animation Function */
      -webkit-animation: pulse 2s linear ;
    }
    
    .shadow {
        -webkit-filter: drop-shadow( 0px 0px 5px white );
                filter: drop-shadow( 0px 0px 5px #000 ); /* Same syntax as box-shadow */
    }
  </style>
</head>
<body>
  <button class="button">Add</button>
  <script src="//d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
      var width = window.innerWidth,
          height = window.innerHeight,
          centered,
          clicked_point;

      var projection = d3.geoMercator()
            .translate([width / 2.2, height / 1.5]);
          
      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("class", "map");
          
      var g = svg.append("g");
      
      // Group to hold all of the alerts elements
      var gAlerts = svg.append('g')
                    .attr('id', 'all-alerts');

      var path = d3.geoPath()
          .projection(projection);
          
          var markers = [
            // {
            //   src_long: 9.083, 
            //   src_lat: 42.149,
            //   dest_long: 103.819839, 
            //   dest_lat: 1.352083
            // }, // corsica
            // {
            //   src_long: 104.195396, 
            //   src_lat: 35.861660,
            //   dest_long: 133.775131, 
            //   dest_lat: -25.274399
            // }, // corsica
            // {long: 2.349, lat: 48.864}, // Paris
            // {long: -1.397, lat: 43.664}, // Hossegor
            // {long: 3.075, lat: 50.640}, // Lille
            // {long: -3.83, lat: 58}, // Morlaix
          ];

              let count = 0;
          d3.selectAll('button').on('click', function() {
            // markers = []
            if(count === 0) {
              markers.push({
              src_long: 104.195396, 
              src_lat: 35.861660,
              dest_long: 133.775131, 
              dest_lat: -25.274399
            });
            count = 1;
            }else {
              markers.push({
                src_long: 9.083, 
              src_lat: 42.149,
              dest_long: 103.819839, 
              dest_lat: 1.352083
            });
            count = 0;
            }
            
            var pulse = function(circle) {
                circle.transition()
                  .delay(function(d) {
                      return 50;
                  })
                  .duration(2000)
                  .attr('r', function(d) {
                    return 20
                  })
                  .style('opacity', 0)
                  .remove();
               };


            const srcDots = svg.selectAll('.alert-src')
                          .data(markers);

            srcDots.enter()
              .append("circle")
              .attr('class', 'circle pulse-circle')
              .attr("cx", function (d) { return projection([d.src_long, d.src_lat])[0]; })
              .attr("cy", function (d) { return projection([d.src_long, d.src_lat])[1]; })
              .attr('r', function(d) {
                  return 5;
              })  
              .attr('fill', 'rgba(240, 52, 52, 0.5)')
              .call(pulse)
              //.merge(srcDots);

              const destDots = svg.selectAll('.alert-dest')
                               .data(markers);

              destDots.enter()
              .append("circle")
              .attr('class', 'circle dest-circle')
              .attr("cx", function (d) { return projection([d.dest_long, d.dest_lat])[0]; })
              .attr("cy", function (d) { return projection([d.dest_long, d.dest_lat])[1]; })
              .attr('r', function(d) {
                  return 5;
              })  
              .attr('fill', 'green')
              .call(pulse)
              //.merge(destDots);

        
            var link = [];
            markers.forEach(function(row){
              source = [+row.src_long, +row.src_lat]
              target = [+row.dest_long, +row.dest_lat]
              topush = {type: "LineString", coordinates: [source, target]}
              link.push(topush)
            });

        var lineTransition = function lineTransition(path) {
            path.transition()
                //NOTE: Change this number (in ms) to make lines draw faster or slower
                .duration(1000)
                .attrTween("stroke-dasharray", tweenDash)
                .on("end", function(d,i) { 
                    d3.select(this).remove();
                })
        };

        var tweenDash = function tweenDash() {
            var len = this.getTotalLength(),
                interpolate = d3.interpolateString("0," + len, len + "," + len);

            return function(t) { return interpolate(t); };
        };

            const line = svg.selectAll("myPath")
                          .data(link);

            line.enter()
            .append("path")
              .attr("d", function(d){ return path(d)})
              .style("fill", "none")
              .style("stroke", "#69b3a2")
              .style("stroke-width", 2)
              .call(lineTransition);

              

              // var pulseCircles = svg.selectAll('.pulse-circle')
              //     .data(markers)
              //     .transition()
              //     .delay(function(d) {
              //         return 50;
              //     })
              //     .duration(2000)
              //     .attr('r', function(d) {
              //       return 20
              //     })
              //     .style('opacity', 0)
              //     .remove();
                  
              //   var pulseCircles2 = svg.selectAll('.dest-circle')
              //     .data(markers)
              //     .transition()
              //     .delay(function(d) {
              //         return 50;
              //     })
              //     .duration(2100)
              //     .attr('r', function(d) {
              //       return 20
              //     })
              //     .style('opacity', 0)
              //     .remove();
              markers.pop();
          });

      // load and display the World
      d3.json("https://unpkg.com/world-atlas@1/world/110m.json", function(error, topology) {
            
            g.selectAll("path")
            .data(topojson.feature(topology, topology.objects.countries)
                .features)
            .enter()
            .append("path")
            .attr("d", path);


            // add circles to svg
            // svg.selectAll('.alert-src')
            //   .data(markers)
            //   .enter()
            //   .append("circle")
            //   .attr('class', 'circle pulse-circle')
            //   .attr("cx", function (d) { return projection([d.src_long, d.src_lat])[0]; })
            //   .attr("cy", function (d) { return projection([d.src_long, d.src_lat])[1]; })
            //   .attr('r', function(d) {
            //       return 5;
            //   })  
            //   .attr('fill', 'rgba(240, 52, 52, 0.5)');

            //   svg.selectAll('.alert-dest')
            //   .data(markers)
            //   .enter()
            //   .append("circle")
            //   .attr('class', 'circle dest-circle')
            //   .attr("cx", function (d) { return projection([d.dest_long, d.dest_lat])[0]; })
            //   .attr("cy", function (d) { return projection([d.dest_long, d.dest_lat])[1]; })
            //   .attr('r', function(d) {
            //       return 5;
            //   })  
            //   .attr('fill', 'green');

              // svg.selectAll('.alert')
              // .data(markers)
              // .enter()
              // .append("circle")
              // .attr('class', 'circle quake-circle')
              // .attr("cx", function (d) { return projection([d.long, d.lat])[0]; })
              // .attr("cy", function (d) { return projection([d.long, d.lat])[1]; })
              // .attr("r", 0)
              // .style("fill", "red")
              // .style('opacity', 0.75);
  
            //   var quakeCircles = svg.selectAll('.quake-circle')
            //  .data(markers)
            //  .transition()
            //  .delay(function(d) {
            //      return 50;
            //  })
            //  .duration(1000)
            //  .attr('r', function(d) {
            //    return 3;
            //  });

        //     var link = [];
        //     markers.forEach(function(row){
        //       source = [+row.src_long, +row.src_lat]
        //       target = [+row.dest_long, +row.dest_lat]
        //       topush = {type: "LineString", coordinates: [source, target]}
        //       link.push(topush)
        //     });

        // var lineTransition = function lineTransition(path) {
        //     path.transition()
        //         //NOTE: Change this number (in ms) to make lines draw faster or slower
        //         .duration(1000)
        //         .attrTween("stroke-dasharray", tweenDash)
        //         .on("end", function(d,i) { 
        //             d3.select(this).remove();
        //         })
        // };

        // var tweenDash = function tweenDash() {
        //     var len = this.getTotalLength(),
        //         interpolate = d3.interpolateString("0," + len, len + "," + len);

        //     return function(t) { return interpolate(t); };
        // };

        //     svg.selectAll("myPath")
        //     .data(link)
        //     .enter()
        //     .append("path")
        //       .attr("d", function(d){ return path(d)})
        //       .style("fill", "none")
        //       .style("stroke", "#69b3a2")
        //       .style("stroke-width", 2)
        //       .call(lineTransition);


        //       var pulseCircles = svg.selectAll('.pulse-circle')
        //           .data(markers)
        //           .transition()
        //           .delay(function(d) {
        //               return 50;
        //           })
        //           .duration(2000)
        //           .attr('r', function(d) {
        //             return 20
        //           })
        //           .style('opacity', 0)
        //           .remove();

              
        //         var pulseCircles2 = svg.selectAll('.dest-circle')
        //           .data(markers)
        //           .transition()
        //           .delay(function(d) {
        //               return 50;
        //           })
        //           .duration(2100)
        //           .attr('r', function(d) {
        //             return 20
        //           })
        //           .style('opacity', 0)
        //           .remove();


      });
      
  </script>
</body>
